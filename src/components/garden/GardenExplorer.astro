---
import GardenCard from '@components/garden/GardenCard.astro';
import {
    SORT_LABELS,
    SORT_TYPES,
    getGardenNoteUrl,
    getGardenSortUrl,
    getGardenTopicSortUrl,
    slugifyTopic,
    type GardenEntry,
    type SortType,
    type TopicOption
} from '@utils/garden';
import '@styles/global.css';

interface Props {
    notes: GardenEntry[];
    topics: TopicOption[];
    currentSort: SortType;
    currentTopic?: string;
}

const { notes, topics, currentSort, currentTopic } = Astro.props;
const totalCount = topics.reduce((sum, topic) => sum + topic.count, 0);
const selectedTopic = topics.find((topic) => topic.slug === currentTopic);

const TOPIC_DOT_COLORS = [
    'bg-light-bl dark:bg-dark-bl',
    'bg-light-pu dark:bg-dark-pu',
    'bg-light-ye dark:bg-dark-ye',
    'bg-light-gr dark:bg-dark-gr',
    'bg-light-cy dark:bg-dark-cy',
    'bg-light-or dark:bg-dark-or',
    'bg-light-ma dark:bg-dark-ma'
];
---

<section class="mx-auto max-w-6xl">
    <div class="flex flex-col gap-8 lg:flex-row lg:items-start lg:justify-between">
        <div class="space-y-4">
            <h2 class="text-light-tx dark:text-dark-tx text-2xl font-semibold">Topics</h2>
            <div class="flex flex-wrap gap-3">
                <a
                    href={getGardenSortUrl(currentSort)}
                    class:list={[
                        'rounded-full border px-4 py-2 text-base font-medium transition-colors',
                        'inline-flex items-center gap-2',
                        !currentTopic
                            ? [
                                  'bg-light-bl dark:bg-dark-bl',
                                  'border-light-bl dark:border-dark-bl',
                                  'text-paper'
                              ]
                            : [
                                  'bg-light-bg dark:bg-dark-bg',
                                  'border-light-ui-2 dark:border-dark-ui-2',
                                  'text-light-tx dark:text-dark-tx',
                                  'hover:bg-light-ui dark:hover:bg-dark-ui'
                              ]
                    ]}
                >
                    <span
                        class:list={[
                            'h-2 w-2 rounded-full',
                            !currentTopic ? 'bg-paper' : 'bg-light-bl dark:bg-dark-bl'
                        ]}
                    ></span>
                    <span>All ({totalCount})</span>
                </a>
                {
                    topics.map((topic, index) => (
                        <a
                            href={getGardenTopicSortUrl(topic.slug, currentSort)}
                            class:list={[
                                'rounded-full border px-4 py-2 text-base font-medium transition-colors',
                                'inline-flex items-center gap-2',
                                currentTopic === topic.slug
                                    ? [
                                          'bg-light-bl dark:bg-dark-bl',
                                          'border-light-bl dark:border-dark-bl',
                                          'text-paper'
                                      ]
                                    : [
                                          'bg-light-bg dark:bg-dark-bg',
                                          'border-light-ui-2 dark:border-dark-ui-2',
                                          'text-light-tx dark:text-dark-tx',
                                          'hover:bg-light-ui dark:hover:bg-dark-ui'
                                      ]
                            ]}
                        >
                            <span
                                class:list={[
                                    'h-2 w-2 rounded-full',
                                    TOPIC_DOT_COLORS[index % TOPIC_DOT_COLORS.length]
                                ]}
                            ></span>
                            <span>
                                {topic.label} ({topic.count})
                            </span>
                        </a>
                    ))
                }
            </div>
        </div>

        <div class="w-full sm:w-64">
            <label
                for="garden-sort"
                class="text-light-tx-2 dark:text-dark-tx-2 mb-2 block text-sm font-medium"
            >
                Sort by
            </label>
            <select
                id="garden-sort"
                class="bg-light-bg dark:bg-dark-bg border-light-ui-2 dark:border-dark-ui-2 text-light-tx dark:text-dark-tx w-full rounded-lg border px-4 py-3 text-base"
                onchange="window.location.href = this.value"
            >
                {
                    SORT_TYPES.map((sortType) => {
                        const href = currentTopic
                            ? getGardenTopicSortUrl(currentTopic, sortType)
                            : getGardenSortUrl(sortType);
                        return (
                            <option value={href} selected={sortType === currentSort}>
                                {SORT_LABELS[sortType]}
                            </option>
                        );
                    })
                }
            </select>
        </div>
    </div>

    {
        selectedTopic && (
            <p class="text-light-tx-2 dark:text-dark-tx-2 mt-6 text-sm">
                Showing {notes.length} note{notes.length === 1 ? '' : 's'} in {selectedTopic.label}.
            </p>
        )
    }

    {
        notes.length > 0 ? (
            <div class="mt-12 grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
                {notes.map((note) => (
                    <GardenCard
                        note={note}
                        href={getGardenNoteUrl(
                            currentTopic ?? slugifyTopic(note.data.topics[0]),
                            note.slug
                        )}
                    />
                ))}
            </div>
        ) : (
            <div class="border-light-ui-2 dark:border-dark-ui-2 mt-12 rounded-xl border p-8 text-center">
                <h3 class="text-light-tx dark:text-dark-tx text-xl font-semibold">No notes yet</h3>
                <p class="text-light-tx-2 dark:text-dark-tx-2 mt-2">
                    Add more garden notes to see them listed here.
                </p>
            </div>
        )
    }
</section>
